@page "/customdropdownLinks"
@typeparam TItem
@using System.Reflection
@using Blazorise
@using Blazorise.Components

<div class="dropdown" @onfocusout="OnFocusOut" @onfocusin="OnFocusIn">
    <InputText @bind-Value="searchText" @oninput="FilterItems" @onfocus="ShowDropdown" Placeholder="Search items..." class="form-control" />
    <div class="dropdown-menu @(isDropdownVisible ? "show" : "")" style="width: 100%;">
        @if (filteredItems.Count == 0)
        {
            <a class="dropdown-item disabled" href="#">No results found.</a>
        }
        else
        {
            @foreach (var item in filteredItems)
            {
                <a class="dropdown-item" href="javascript:void(0)" @onclick="() => OnSelectedValueChanged(GetPropertyValue(item, IdPropertyName))">@GetPropertyValue(item, DisplayPropertyName) - @(GetPropertyValue(item, IdPropertyName)) </a>
            }
        }
    </div>
</div>

@code {
    [Parameter]
    public List<TItem> Items { get; set; }

    [Parameter]
    public string DisplayPropertyName { get; set; }

    [Parameter]
    public string IdPropertyName { get; set; }

    [Parameter]
    public EventCallback<string> ValueChanged { get; set; }

    private string searchText = string.Empty;
    private bool isDropdownVisible = false;
    private List<TItem> filteredItems = new();

    protected override void OnParametersSet()
    {
        filteredItems = new List<TItem>(Items);
    }

    private async Task OnSelectedValueChanged(object idValue)
    {
        string id = Convert.ToString(idValue);
        var selectedItem = Items.FirstOrDefault(item => GetPropertyValue(item, IdPropertyName).Equals(idValue));
        if (selectedItem != null)
        {
            searchText = GetPropertyValue(selectedItem, DisplayPropertyName).ToString();
        }
        filteredItems = new List<TItem>(Items);
        await ValueChanged.InvokeAsync(id);
        await Task.Delay(150); // Delay to allow the click event to be processed
        isDropdownVisible = false;
    }

    private void FilterItems(ChangeEventArgs e)
    {
        searchText = e.Value.ToString();
        if (string.IsNullOrWhiteSpace(searchText))
        {
            filteredItems = new List<TItem>(Items);
        }
        else
        {
            filteredItems = Items.Where(x => GetPropertyValue(x, DisplayPropertyName).ToString().Contains(searchText, StringComparison.OrdinalIgnoreCase) || GetPropertyValue(x, IdPropertyName).ToString().Contains(searchText, StringComparison.OrdinalIgnoreCase)).ToList();
        }
    }

    private void ShowDropdown()
    {
        isDropdownVisible = true;
    }

    private async Task OnFocusIn(FocusEventArgs e)
    {
        ShowDropdown();
    }

    private async Task OnFocusOut(FocusEventArgs e)
    {
        // Delay hiding to allow interaction with dropdown items
        await Task.Delay(150);
        isDropdownVisible = false;
    }

    private object GetPropertyValue(object obj, string propertyName)
    {
        return obj.GetType().GetProperty(propertyName).GetValue(obj);
    }
}
